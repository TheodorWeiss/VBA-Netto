Option Explicit

Public Sub ShadeAndFill_FromWerbung_OneSheet()
    Const SHT_MAIN As String = "Werbung_Reordered" ' работаем с ОДНИМ листом
    Const SHT_SRC  As String = "Werbung"           ' источник
    Const START_ROW As Long = 3                    ' первая серая строка
    Const FIRST_COL As Long = 1                    ' A
    Const LAST_COL  As Long = 9                    ' I
    Const GRAY_INDEX As Long = 15                  ' светло-серый (ColorIndex)

    Dim ws As Worksheet, wsrc As Worksheet
    Set ws = ThisWorkbook.Worksheets(SHT_MAIN)
    Set wsrc = ThisWorkbook.Worksheets(SHT_SRC)

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, "B").End(xlUp).Row
    If lastRow < START_ROW Then GoTo TidyExit

    ' -------- 1) Собираем номера «серых» строк --------
    Dim grayRows As Collection: Set grayRows = New Collection
    grayRows.Add START_ROW ' строка 3 всегда серая

    Dim r As Long, prevFirst As String, curFirst As String
    prevFirst = FirstWord(CStr(ws.Cells(START_ROW, "B").Value))

    For r = START_ROW + 1 To lastRow
        curFirst = FirstWord(CStr(ws.Cells(r, "B").Value))
        If StrComp(curFirst, prevFirst, vbTextCompare) <> 0 Then
            grayRows.Add r
        End If
        prevFirst = curFirst
    Next r

    ' очистим заливку A:I и прокрасим нужные строки
    ws.Range(ws.Cells(START_ROW, FIRST_COL), ws.Cells(lastRow, LAST_COL)).Interior.Pattern = xlNone

    Dim i As Long
    For i = 1 To grayRows.Count
        r = CLng(grayRows(i))
        ws.Range(ws.Cells(r, FIRST_COL), ws.Cells(r, LAST_COL)).Interior.ColorIndex = GRAY_INDEX
    Next i

    ' -------- 2) Подготовим источник по городу --------
    Dim city As String: city = Trim$(CStr(ws.Range("B1").Value))
    If Len(city) = 0 Then
        MsgBox "В ячейке B1 не указан город.", vbExclamation
        GoTo TidyExit
    End If

    Dim srcStart As Long, srcEnd As Long
    srcStart = FindCityHeaderOnWerbung(wsrc, city)
    If srcStart = 0 Then
        MsgBox "Город '" & city & "' не найден на листе '" & SHT_SRC & "'.", vbExclamation
        GoTo TidyExit
    End If
    srcEnd = FindNextCityHeaderBelowWerbung(wsrc, srcStart + 1)
    If srcEnd = 0 Then srcEnd = wsrc.Cells(wsrc.Rows.Count, "A").End(xlUp).Row + 1

    ' соберём записи из блока города: A, C, E и ЖИРНЫЕ фрагменты из D
    Dim srcData As Collection: Set srcData = New Collection
    Dim rr As Long, rec As Variant, boldPart As String

    For rr = srcStart + 1 To srcEnd - 1
        If HasAnyValue(wsrc, rr, Array("A", "C", "D", "E")) Then
            boldPart = ExtractBoldText(wsrc.Cells(rr, "D"))
            rec = Array( _
                wsrc.Cells(rr, "A").Value, _
                wsrc.Cells(rr, "C").Value, _
                wsrc.Cells(rr, "E").Value, _
                boldPart)
            srcData.Add rec
        End If
    Next rr

    ' -------- 3) Переносим по порядку в серые строки --------
    Dim n As Long
    n = Application.WorksheetFunction.Min(grayRows.Count, srcData.Count)
    If n = 0 Then GoTo TidyExit

    For i = 1 To n
        r = CLng(grayRows(i))
        rec = srcData(i)            ' коллекция 1-based; rec(0..3)

        ws.Cells(r, "A").Value = rec(0) ' из A (Werbung) -> A
        ws.Cells(r, "G").Value = rec(1) ' из C (Werbung) -> G
        ws.Cells(r, "H").Value = rec(2) ' из E (Werbung) -> H

        ' Жирная часть из D -> J; если начинается с "+", ставим апостроф
        Dim s As String
        s = CStr(rec(3))
        If Len(s) > 0 Then
            If Left$(s, 1) = "+" Then
                ws.Cells(r, "J").Value = "'" & s
            Else
                ws.Cells(r, "J").Value = s
            End If
        Else
            ws.Cells(r, "J").ClearContents
        End If
    Next i

TidyExit:
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
End Sub

' ====== ВСПОМОГАТЕЛЬНЫЕ ======

Private Function FirstWord(ByVal s As String) As String
    s = Trim$(s)
    If Len(s) = 0 Then
        FirstWord = ""
    Else
        FirstWord = Split(s, " ")(0)
    End If
End Function

Private Function FindCityHeaderOnWerbung(ByVal ws As Worksheet, ByVal city As String) As Long
    Dim last As Long, r As Long
    last = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    For r = 1 To last
        If StrComp(Trim$(CStr(ws.Cells(r, "A").Value)), city, vbTextCompare) = 0 Then
            FindCityHeaderOnWerbung = r
            Exit Function
        End If
    Next r
End Function

Private Function FindNextCityHeaderBelowWerbung(ByVal ws As Worksheet, ByVal startRow As Long) As Long
    Dim last As Long, r As Long
    last = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    For r = startRow To last
        If Len(Trim$(CStr(ws.Cells(r, "A").Value))) > 0 Then
            If ws.Cells(r, "B").Value = "" And ws.Cells(r, "A").Font.Bold Then
                FindNextCityHeaderBelowWerbung = r
                Exit Function
            End If
        End If
    Next r
End Function

Private Function HasAnyValue(ws As Worksheet, ByVal rowNum As Long, cols As Variant) As Boolean
    Dim i As Long
    For i = LBound(cols) To UBound(cols)
        If Len(Trim$(CStr(ws.Cells(rowNum, CStr(cols(i))).Value))) > 0 Then
            HasAnyValue = True
            Exit Function
        End If
    Next i
End Function

' Извлекает только жирные фрагменты текста из ячейки (если их несколько — склеивает через пробел).
Private Function ExtractBoldText(ByVal rng As Range) As String
    Dim txt As String: txt = CStr(rng.Value)
    If Len(txt) = 0 Then Exit Function

    Dim i As Long, segStart As Long, segLen As Long
    Dim isBold As Boolean, curBold As Boolean
    Dim result As String

    If Len(txt) = 0 Then
        ExtractBoldText = ""
        Exit Function
    End If

    curBold = False
    segStart = 0
    segLen = 0

    For i = 1 To Len(txt)
        isBold = rng.Characters(i, 1).Font.Bold
        If isBold <> curBold Then
            If curBold And segLen > 0 Then
                If Len(result) > 0 Then result = result & " "
                result = result & Mid$(txt, segStart, segLen)
            End If
            curBold = isBold
            segStart = i
            segLen = 1
        Else
            segLen = segLen + 1
        End If
    Next i

    ' добавить хвост, если он жирный
    If curBold And segLen > 0 Then
        If Len(result) > 0 Then result = result & " "
        result = result & Mid$(txt, segStart, segLen)
    End If

    ExtractBoldText = Trim$(result)
End Function
